<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Sonos Groups Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
html, body {
  margin: 0;
  padding: 0;
  height: 100%;
  width: 100%;
  background: #000;
  color: #eee;
  font-family: system-ui, sans-serif;
  overflow: hidden;
}

#groups {
  display: flex;
  justify-content: center;
  align-items: center;
  width: 92%;
  height: 100%;
  margin: 0 auto;
  box-sizing: border-box;
  gap: 1.5%;
  font-size: calc(1rem * var(--scale, 1));
}

.group-row {
  display: grid;
  justify-items: center;
  align-items: center;
  width: 100%;
  height: 100%;
  gap: 1.5%;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.group-card {
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  background: #111;
  border-radius: 0.8em;
  border: 0.25em solid transparent;
  overflow: hidden;
  transition: background 0.3s ease, border 0.3s ease;
  height: 80%;
  width: 95%;
  box-sizing: border-box;
}

.group-card.playing { border-color: #0f0a; background: #101910; }
.group-card.paused_playback { border-color: #ffa500aa; background: #191910; }
.group-card.stopped { border-color: #555a; background: #151515; }

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ IMAGE â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.artwork {
  flex: 0 0 50%;
  width: 100%;
  object-fit: cover;
  background: #333;
  border-bottom: 0.15em solid #222;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ INFO â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.info {
  flex: 1;
  display: flex;
  flex-direction: column;
  justify-content: flex-start;
  padding: 0.6em 0.9em;
  font-size: 1.2em;
  box-sizing: border-box;
  overflow: hidden;
}

.group-name {
  font-weight: 700;
  color: #fff;
  font-size: 1.1em;
  margin-bottom: 0.25em;
  display: flex;
  align-items: center;
  flex-wrap: wrap;
  gap: 0.4em;
}

.track-title {
  font-weight: 600;
  color: #f6c36a;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.artist, .album, .source {
  color: #bbb;
  font-size: 0.95em;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.members {
  margin-top: 0.4em;
  font-size: 0.85em;
  color: #aaa;
  line-height: 1.3;
  overflow: hidden;
}
.members span { display: block; }

.badge {
  font-size: 0.7em;
  padding: 0.15em 0.45em;
  border-radius: 0.3em;
  background: #333;
  color: #ccc;
}

/* â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.controls {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  padding: 0.5em 0.8em;
  border-top: 0.15em solid #222;
  gap: 0.4em;
}

.button-row {
  display: flex;
  justify-content: center;
  align-items: center;
  gap: 0.6em;
}

.controls button {
  background: #222;
  color: #eee;
  border: none;
  border-radius: 0.4em;
  padding: 0.35em 0.6em;
  font-size: 1.3em;
  cursor: pointer;
  transition: background 0.2s ease, transform 0.1s ease;
}
.controls button:hover { background: #444; transform: scale(1.1); }
.controls button:active { background: #666; transform: scale(0.95); }

.volume-control {
  display: flex;
  align-items: center;
  gap: 0.4em;
  width: 85%;
}
.volume-control input[type="range"] {
  width: 100%;
}

#last-updated {
  position: fixed;
  bottom: 0.4em;
  right: 0.8em;
  font-size: 0.8em;
  color: #777;
}
</style>
</head>
<body>
<div id="groups"><div class="group-row" id="group-row"></div></div>
<div id="last-updated"></div>

<script>
async function fetchGroups() {
  try {
    const res = await fetch("/api/v1/sonos/groups");
    if (!res.ok) throw new Error(res.statusText);
    const data = await res.json();
    data.groups.sort((a, b) => a.name.localeCompare(b.name));
    renderGroups(data.groups);
  } catch (err) {
    console.error("Error fetching groups:", err);
    document.getElementById("last-updated").innerText = "Error loading data";
  }
}

function volumeIcon(vol) {
  if (vol == null) return "â€”";
  if (vol < 10) return "ğŸ”ˆ";
  if (vol < 25) return "ğŸ”‰";
  return "ğŸ”Š";
}

async function sendSonosCommand(action, id) {
  try {
    const res = await fetch(`/api/v1/sonos/${action}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id }),
    });
    if (!res.ok) throw new Error(await res.text());
    console.log(`âœ… ${action} sent to ${id}`);
    fetchGroups(); // refresh
  } catch (err) {
    console.error(`âŒ Failed ${action}:`, err);
  }
}

async function setVolume(id, level) {
  try {
    const res = await fetch(`/api/v1/sonos/volume`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ id, level }),
    });
    if (!res.ok) throw new Error(await res.text());
    console.log(`ğŸ”Š Volume ${level} set for ${id}`);
  } catch (err) {
    console.error("âŒ Volume error:", err);
  }
}

function renderGroups(groups) {
  const row = document.getElementById("group-row");
  row.innerHTML = "";
  document.getElementById("last-updated").textContent =
    "Updated " + new Date().toLocaleTimeString();

  const totalSlots = Math.max(1, groups.length);
  row.style.gridTemplateColumns = `repeat(${totalSlots}, 1fr)`;

  groups.forEach((g) => {
    const card = document.createElement("div");
    card.className = `group-card ${g.status}`;

    const img = document.createElement("img");
    img.className = "artwork";
    img.alt = g.name;
    if (g.track.artwork && g.track.artwork !== "/placeholder.jpg") {
      img.src = g.track.artwork;
    } else {
      img.src = "/cache/artwork/spotify-default.jpg";
    }
    img.onerror = () => {
      console.warn("Artwork failed for", g.name, "â†’ using default");
      img.src = "/cache/artwork/spotify-default.jpg";
    };

    const info = document.createElement("div");
    info.className = "info";
    const memberLines = g.members
      .map((m) => `<span>${m.name}: ${volumeIcon(m.volume)} ${m.volume ?? ""}</span>`)
      .join("");

    info.innerHTML = `
      <div class="group-name">
        ${g.name}
        <span class="badge">${g.status}</span>
      </div>
      <div class="track-title">${g.track.title || "â€”"}</div>
      <div class="artist">${g.track.artist || ""}</div>
      <div class="album">${g.track.album || ""}</div>
      <div class="source">ğŸ§ ${g.track.source || "Unknown"}</div>
      <div class="members">
        ${memberLines}
        <span><strong>Avg:</strong> ${volumeIcon(g.avgVolume)} ${g.avgVolume ?? "â€”"}</span>
      </div>
    `;

    /* â”€â”€â”€â”€â”€â”€â”€â”€â”€ CONTROLS â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    const controls = document.createElement("div");
    controls.className = "controls";
    const isPlaying = g.status === "playing";
    controls.innerHTML = `
      <div class="button-row">
        <button title="Previous">â®ï¸</button>
        <button title="${isPlaying ? "Pause" : "Play"}" class="toggle-btn">
          ${isPlaying ? "â¸ï¸" : "â–¶ï¸"}
        </button>
        <button title="Next">â­ï¸</button>
      </div>
      <div class="volume-control">
        <span id="vol-icon">${volumeIcon(g.avgVolume)}</span>
        <input type="range" min="0" max="100" value="${g.avgVolume ?? 0}" />
      </div>
    `;

    const btnPrev = controls.querySelector('button[title="Previous"]');
    const btnNext = controls.querySelector('button[title="Next"]');
    const btnToggle = controls.querySelector(".toggle-btn");
    const slider = controls.querySelector("input[type=range]");
    const volIconEl = controls.querySelector("#vol-icon");

    btnPrev.onclick = () => sendSonosCommand("previous", g.id);
    btnNext.onclick = () => sendSonosCommand("next", g.id);
    btnToggle.onclick = async () => {
      const newAction = g.status === "playing" ? "pause" : "play";
      await sendSonosCommand(newAction, g.id);
      // Toggle icon immediately for user feedback
      g.status = newAction === "play" ? "playing" : "stopped";
      btnToggle.textContent = newAction === "play" ? "â¸ï¸" : "â–¶ï¸";
      btnToggle.title = newAction === "play" ? "Pause" : "Play";
    };

    slider.oninput = (e) => {
      const level = e.target.value;
      volIconEl.textContent = volumeIcon(level);
    };
    slider.onchange = (e) => setVolume(g.id, e.target.value);

    card.append(img, info, controls);
    row.appendChild(card);
  });
}

/* ---------- Dynamic scaling ---------- */
function updateScale() {
  const root = document.documentElement;
  const h = document.documentElement.clientHeight || document.body.clientHeight;
  const base = 800;
  let scale = h / base;
  if (scale < 0.8) scale = 0.8;
  if (scale > 2.0) scale = 2.0;
  root.style.setProperty("--scale", scale.toFixed(3));
}
window.addEventListener("resize", updateScale);
new ResizeObserver(updateScale).observe(document.body);

updateScale();
fetchGroups();
setInterval(fetchGroups, 15000);
</script>
</body>
</html>
