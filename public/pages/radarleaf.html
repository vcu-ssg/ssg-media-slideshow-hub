<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>NWS Radar Viewer</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body{margin:0;height:100%}
    #map{width:100%;height:100%}
    #loading{
      position:absolute;top:10px;left:50%;transform:translateX(-50%);
      background:rgba(0,0,0,.6);color:#fff;padding:6px 12px;
      border-radius:6px;font-family:"Segoe UI",sans-serif;z-index:1000
    }
  </style>
</head>
<body>
  <div id="loading">Loading radar map…</div>
  <div id="map"></div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
  const params = new URLSearchParams(location.search);
  const zip = params.get("zip");
  const city = params.get("city");
  const lat = parseFloat(params.get("lat"));
  const lon = parseFloat(params.get("lon"));
  const scale = params.get("scale") || "25mi";

  const scaleToZoom = {"5mi":12,"10mi":11,"25mi":9,"50mi":8,"100mi":7,"200mi":6};
  const zoom = scaleToZoom[scale] || 9;
  const loadingEl = document.getElementById("loading");

  function cacheGet(k){try{const d=JSON.parse(localStorage.getItem(k));if(!d)return null;
    if(Date.now()-d.ts>86400000)return null;return d.v;}catch{return null;}}
  function cacheSet(k,v){localStorage.setItem(k,JSON.stringify({ts:Date.now(),v}));}

  async function geocode(){
    if(lat&&lon) return {lat,lon,name:`(${lat.toFixed(2)},${lon.toFixed(2)})`};
    const key = zip?`zip:${zip}`:`city:${city}`;
    const cached = cacheGet(key); if(cached) return cached;

    let q = city||zip;
    const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}`);
    const d = await r.json();
    if(!d.length) throw new Error("Geocode failed");
    const v = {lat:+d[0].lat,lon:+d[0].lon,name:d[0].display_name};
    cacheSet(key,v); return v;
  }

  async function init(){
    try{
      const loc = await geocode();
      loadingEl.textContent = `Centering near ${loc.name}`;
      const map = L.map("map").setView([loc.lat,loc.lon],zoom);

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png",{
        maxZoom:12,attribution:"© OpenStreetMap"
      }).addTo(map);

      // ✅ Correct radar layer (base reflectivity)
      const radarUrl = 
        "https://mesonet.agron.iastate.edu/cache/tile.py/1.0.0/nexrad-n0q-900913/{z}/{x}/{y}.png";

      L.tileLayer(radarUrl,{
        tms:false,
        opacity:0.7,
        maxZoom:12,
        attribution:"Radar © NOAA/NWS via Iowa State Mesonet"
      }).addTo(map);

      loadingEl.remove();
    }catch(e){
      console.error(e);
      loadingEl.textContent="⚠ "+e.message;
    }
  }
  init();
  </script>
</body>
</html>
